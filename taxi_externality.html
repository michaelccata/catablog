<!DOCTYPE html>
<!-- This site was created in Webflow. http://www.webflow.com-->
<!-- Last Published: Thu May 19 2016 16:54:32 GMT+0000 (UTC) -->
<html data-wf-site="573c7875103e63f747af0609" data-wf-page="573c7875103e63f747af061d">
<head>
  <meta charset="utf-8">
  <title>{{name}} | Blog</title>
  <meta name="description" content="{{post-summary}}">
  <meta property="og:title" content="{{name}}">
  <meta property="og:description" content="{{post-summary}}">
  <meta property="og:image">
  <meta name="twitter:card" content="summary">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Webflow">
  <link rel="stylesheet" type="text/css" href="css/normalize.css">
  <link rel="stylesheet" type="text/css" href="css/webflow.css">
  <link rel="stylesheet" type="text/css" href="css/michael-cata.webflow.css">
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ["Open Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic","Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic","PT Sans:400,400italic,700,700italic","Fjalla One:regular","Playfair Display:regular,italic,700,700italic,900,900italic"]
      }
    });
  </script>
  <script type="text/javascript" src="js/modernizr.js"></script>
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon-32x32.png">
  <link rel="apple-touch-icon" href="https://daks2k3a4ib2z.cloudfront.net/img/webclip.png">
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-66979201-1'], ['_trackPageview']);
    (function() {
      var ga = document.createElement('script');
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>
<body>
  <div class="sidebar-column">
    <div data-collapse="medium" data-animation="default" data-duration="400" data-contain="1" class="w-nav navigation-bar">
      <div class="w-container"><a href="#" class="w-nav-brand logo-link"><h1 class="logo-text">Michael Cata</h1></a>
        <nav role="navigation" class="w-nav-menu navigation-menu">
          <p class="w-hidden-medium w-hidden-small w-hidden-tiny main-subheading">organizations, data, econ stuff</p>
          <div class="w-hidden-medium w-hidden-small w-hidden-tiny divider"></div><a href="index.html" class="w-nav-link nav-link">ME</a><a href="all-posts.html" class="w-nav-link nav-link">READ</a><a href="about.html" class="w-nav-link nav-link">WORK</a><a href="contact.html" class="w-nav-link nav-link">COFFEE?</a>
          <div class="divider"></div>
          <div class="social-link-group">
            <a href="#" class="w-inline-block social-icon-link"><img width="25" src="images/social-33.svg">
            </a>
			<a href="#" class="w-inline-block social-icon-link"><img width="25" src="images/social-18.svg">
            </a>
            <a href="#" class="w-inline-block social-icon-link"><img width="25" src="images/social-09_1.svg">
            </a>
            <a href="#" class="w-inline-block social-icon-link"><img width="25" src="images/social-25.svg">
            </a>
            <a href="#" class="w-inline-block social-icon-link"><img width="47" src="images/social-40.svg">
            </a>
            
          </div>
        </nav>
        <div class="w-nav-button menu-button">
          <div class="w-icon-nav-menu"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="content">
    <div class="w-container">
      <div class="post-title-section">
        <h1 class="blog-title">Opting for Cabs: The Hidden Benefit(?) of Construction</h1>
		<h6>New Yorkers spend millions on taxis when subways undergo maintenance on the weekends.</h6>
        <div class="post-info-wrapper">
          <div class="post-info">01/2016</div>
          <div class="post-info">|</div>
          <a class="post-info when-link">PUBLIC POLICY + EXTERNALITIES</a>
        </div>
      </div>
      <div class="w-richtext body-copy">
        <!-- <p>Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts. Separated they live in Bookmarksgrove right at the coast of the Semantics, a large language ocean. A small river named Duden flows by their place and supplies it with the necessary regelialia.</p>
        <h2>On deer horse aboard tritely yikes and much</h2>
        <p>The Big Oxmox advised her not to do so, because there were thousands of bad Commas, wild Question Marks and devious Semikoli, but the Little Blind Text didn’t listen. She packed her seven versalia, put her initial into the belt and made herself on the way.</p>
        <ul>
          <li>This however showed weasel</li>
          <li>Well uncritical so misled</li>
          <li>Goodness much until that fluid owl</li>
        </ul>
        <p data-new-link="true">When she reached the first hills of the <strong>Italic Mountains</strong>, she had a last view back on the skyline of her hometown <em>Bookmarksgrove</em>, the headline of <a href="http://google.com">Alphabet Village</a> and the subline of her own road, the Line Lane. Pityful a rethoric question ran over her cheek, then she continued her way. On her way she met a copy.</p>
        <h3>Overlaid the jeepers uselessly much excluding</h3>
        <p>But nothing the copy said could convince her and so it didn’t take long until a few insidious Copy Writers ambushed her, made her drunk with <a href="http://google.com">Longe and Parole</a> and dragged her into their agency, where they abused her for their projects again and again. And if she hasn’t been rewritten, then they are still using her.</p>
        <blockquote>Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts. Separated they live in Bookmarksgrove right at the coast of the Semantics, a large language ocean.&nbsp;</blockquote>
        <p>It is a paradisematic country, in which roasted parts of sentences fly into your mouth. Even the all-powerful Pointing has no control about the blind texts it is an almost unorthographic life One day however a small line of blind text by the name of Lorem Ipsum decided to leave for the far World of Grammar.</p>
        <h3>According a funnily until pre-set or arrogant well cheerful</h3>
        <p>The Big Oxmox advised her not to do so, because there were thousands of bad Commas, wild Question Marks and devious Semikoli, but the Little Blind Text didn’t listen. She packed her seven versalia, put her initial into the belt and made herself on the way.</p>
        <ol>
          <li>So baboon this</li>
          <li>Mounted militant weasel gregariously admonishingly straightly hey</li>
          <li>Dear foresaw hungry and much some overhung</li>
          <li>Rash opossum less because less some amid besides yikes jeepers frenetic impassive fruitlessly shut</li>
        </ol>
        <p>When she reached the first hills of the Italic Mountains, she had a last view back on the skyline of her hometown Bookmarksgrove, the headline of Alphabet Village and the subline of her own road, the Line Lane. Pityful a rethoric question ran over her cheek, then she continued her way. On her way she met a copy.</p>
        <blockquote>The copy warned the Little Blind Text, that where it came from it would have been rewritten a thousand times and everything that was left from its origin would be the word "and" and the Little Blind Text should turn around and return to its own, safe country.</blockquote>
        <p>But nothing the copy said could convince her and so it didn’t take long until a few insidious Copy Writers ambushed her, made her drunk with Longe and Parole and dragged her into their agency, where they abused her for their projects again and again. And if she hasn’t been rewritten, then they are still using her. Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts.</p>
        <h4>Silent delightfully including because before one up barring chameleon</h4>
        <figure data-rt-type="image" data-rt-align="center" data-rt-max-width="60" class="w-richtext-align-center" style="max-width: 60%;" data-rt-max-height="33.75">
          <div><img src="images/photo-1433763472432-7970c9ba5349-bw.jpg" alt="">
          </div>
          <figcaption>This is a caption</figcaption>
        </figure>
        <p>Separated they live in Bookmarksgrove right at the coast of the Semantics, a large language ocean. A small river named Duden flows by their place and supplies it with the necessary regelialia. It is a paradisematic country, in which roasted parts of sentences fly into your mouth.</p>
        <p>Even the all-powerful Pointing has no control about the blind texts it is an almost unorthographic life One day however a small line of blind text by the name of Lorem Ipsum decided to leave for the far World of Grammar. The Big Oxmox advised her not to do so, because there were thousands of bad Commas, wild Question Marks and devious Semikoli, but the Little Blind Text didn’t listen.</p>
        <h5>Wherever far wow thus a squirrel raccoon jeez jaguar this from along</h5>
        <p>She packed her seven versalia, put her initial into the belt and made herself on the way. When she reached the first hills of the Italic Mountains, she had a last view back on the skyline of her hometown Bookmarksgrove, the headline of Alphabet Village and the subline of her own road, the Line Lane. Pityful a rethoric question ran over her cheek, then she continued her way. On her way she met a copy.</p>
        <h6>Slapped cozy a that lightheartedly and far</h6>
        <p>The copy warned the Little Blind Text, that where it came from it would have been rewritten a thousand times and everything that was left from its origin would be the word "and" and the Little Blind Text should turn around and return to its own, safe country. But nothing the copy said could convince her and so it didn’t take long until a few insidious Copy Writers ambushed her, made her drunk with Longe and Parole and dragged her into their agency, where they abused her for their projects again and again.</p> -->
      </div>
      <div class="w-richtext body-copy">
										
										<section>
									
											<p><b>You have several choices when your subway service is disrupted:</b></p>
												<ol><li>Get those steps in! - walk up to 20 blocks</li>
												<li>Take the bus - wherever that's supposed to happen</li>
												<li>Hail a cab or call an Uber - $$$</li>
												<li>Turn around, go home, fall onto the bed</li></ol>
									
											<p><b>It's a drag when we're presented with the trade-off framed above.</b> Often, you’re forced to hand over the extra cash and spring for the cab. But if this happens to lots of people, across the city, every week, that’s an economic impact that’s hard to ignore.</p> 
									
											<p><font color="#FF0000" size="+2"><marquee bgcolor="#FFFFFF"   scrollamount="8">ECON NERD ALERT</marquee></font></p>
									
												<p><b>Externality is the official term for this sort of impact.</b></p> 
										
													<blockquote>A cost or benefit that affects a party who did not choose to incur that cost or benefit</blockquote>
									
												<p><b>When you buy a Metrocard, you sign-up for the occasional maintenance necessary to keep the whole system moving.</b>  I thought long and hard if the forced alternative modes of transportation created a negative externality (cost) for commuters. I decided no. Maintenance and it’s associated costs are part of the social contract between commuters and the MTA. Side-effects are baked into the relationship.</p>
									
												<p><b>Cabbies, on the other hand, benefit from the situation and as a third party.</b> They experience a *positive externality* with the extra cash in their pockets, stemming from a phenomena they had no part in shaping.</b></p>
									
											<p><font color="#FF0000" size="+2"><marquee bgcolor="#FFFFFF"   scrollamount="10">ECON NERD ALERT</marquee></font></p>
									
											<p><b>So how many people defer to option 3, hailing a cab?</b>  It’s an important question for policymakers to ask. If the MTA considers the lost ridership revenue, cost of contractors, and future maintenance, shouldn’t they consider the external effects of planned maintenance?</p>
									
											<p><b>I spent the last six months data-mining, researching, hacking, and FOIA haggling to wrangle construction records and taxi-trip data from the MTA and TLC.</b> The analysis below is the result of some pretty cool engineering and really lucky events, if you want a deeper dive, feel free to check out the <a href="#how">“How did I do this below”.</a></p>
											<p><b>Let’s start with a pair of Saturdays in July, 2013.</b>  The 6th and 13th were both sunny, mid-70s, beautiful summer days in Manhattan. Elliot Spitzer resigned on the 6th and the Yankees lost an away game on the 13th. Demand for public transportation was likely identical on both days.</p>
									
											<p>
												<iframe title="On a normal Saturday" width="47%" height="700" frameborder="0" src="https://michaelcata.cartodb.com/viz/587ff89c-a0f1-11e5-b0f6-0ecd1babdde5/embed_map" allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>
												<iframe title="A week later with construction" width="47%" height="700" frameborder="0" src="https://michaelcata.cartodb.com/viz/d42e1d8a-a0f0-11e5-ae62-0e98b61680bf/embed_map" allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>
											</p>
									
											<p><b>The only difference?</b>  Planned maintenance on the 4,5,6 closed local stops on the uptown and downtown tracks between Brooklyn Bridge and 86th St on 7/13/2013.</p>
											<p><b>AKA you were $0L if you lived on Canal and wanted to take the subway to the Met on 81st.</b> </p>
									
										
											<p><b>The two heat-maps show stark differences.</b> Taxi pickups on the 13th had greater intensity along the 4,5,6 corridor, especially near main transit hubs at Union Square, Grand Central, and 59th St.</p>
	
											<p><b>Madison Square Park is a good reference point.</b> The area is bordered by two Local 6 train stations, the 23rd and 28th St stops. Both of those options were closed to everyone attempting to depart the area.</p>
									
											<p><b>*ZOOM IN AND ENHANCE*</b></p>
									
											<!-- <div class="image"><iframe frameborder="0" class="juxtapose" style="IDNAME" width="100%" height="511.41739130434786" src="https://cdn.knightlab.com/libs/juxtapose/latest/embed/index.html?uid=0ce3b7fc-b4a6-11e5-a524-0e7075bba956"></iframe></p> -->
									
											<!--<div class="image"><img src="images/spykids.gif" alt="" height="auto" width="50%" /></div> -->
									
											<div class="image"><img src="images/construction.gif" alt="" height="auto" width="51%" /></div>
											<br></br>
									
											<p><b>Pick-ups on the 13th are more intense and concentrated within the half-block radius of each station.</b> There’s also heavier traffic on the avenues. It’s possible that folks on Lexington and 3rd, the two vertical stretches to the left of the markers, looked at Google or Embark and realized they were out of luck before walking to the station.</p>
											<p><b>The verdict: more people needed rides on a day with construction as compared to just a week prior when everything was running smoothly.</b></p>
									
											<p><b>To dig deeper, let's look at some summary statistics.</b> The chart below shows the per-minute figures for ridership and fare totals. Several tests demonstrated statistically different averages between normal and construction days.</p>
									
											<div class="image" ><img src="images/statsmean.png" alt="" height="auto" width="65%"/></div>
											<br></br>
									
											<p><b>We expect that with more rides, come higher revenue and the data confirms that hypothesis.</b> A side note, however, is that the average fare on a given ride is higher during subway construction. My hypothesis? Folks use the subway for longer treks, and without that option they are forced to pay for an unexpectedly far trip.</p>
									
											<p><b>The pattern repeats itself on other comparisons and validates the original hypothesis: subway construction affects taxi markets.</b> I examined the last three years of taxi records and split the group on the basis of construction or no-construction. The benchmark -> does the maintenance cause delays that “heavily affect ridership” a standard the MTA used in their file.</p>
									
											<div class="image" ><img src="images/taxirevenue3.svg" alt="" height="auto" width="90%"/></div>
											<br></br>
									
											<p><b>Subway construction, on average, does increase taxi-pickups.</b> The gap between the green and red lines is statistically significant. Both curves also have the same shape. General cab-hailing behavior peaks at the expected times. The average revenue just has a <b>higher magnitude</b> when the subways go down.</p>
									
											<iframe align="center" height="360" width="75%" src="https://docs.google.com/spreadsheets/d/1tALmZNRsA-NsmUbPNBhg7WnrRAvygXcQWmWOkv4W21s/pubhtml?gid=0&amp;single=true&amp;widget=true&amp;headers=false"></iframe>
											<br></br>
									
											<p><b>Construction on the Lexington Line creates demand for about $1.5million in rides every year.</b> We get this number with some 11th grade calculus: calculate the area under each curve and finding the difference for both Saturday and Sunday trends. (Check out the math/formulas below)</p>
									
											<p><b>City-wide impact hovers around an annual $12million externality for cab drivers.</b> My analysis focused only the Manhattan portion of the 4,5,6 tracks. If we extrapolate the figures and multiply by the other 8 "trunk lines" we see the larger impact unfold.</p>
									
											<p><b>The MTA invests over $2.5 billion on subway maintenance, repairs, and improvements every year.</b> 
												That's about $300 for every woman, man, and child across the 5 boros. 
												Whether you're paying elevated state and city taxes or forking over cash at the MetroCard kiosk, everyone shares in the burden.</p>
										
											<p><b>The impact I found, relative to total ridership and capital investment, is miniscule.</b> We're talking basis-points range. But the externality is still real. $400 in extra income for cab drivers, who make on median $33,000/year (and dropping), is a significant boost that wouldn't exist without disruptive subway construction.</p>	
									
											<p><b>Does it matter that cab drivers benefit from subway construction?</b><strong><b>*YES*</b></strong> Taxi companies like inconvenient public transportation (see: lack of easy access to LaGuardia + JFK.) But the market still isn't efficient. Cab rates stay the same despite higher demand.</p> 
											<p><b>That's what firms like Uber are exploiting with surge pricing.</b> Without strong protections to stem private benefits of public transit interruption, commuters are vulnerable to even higher costs when subways go down. And no one bargained for that when they bought their Metrocard.</p>
									
											<hr / id="how">
									
											<header >
												<h2>So how'd ya do it?</h2>
												<p>A saga working with BigQuery, GEOdata, and FOIA</p>
											</header>
									
											<p>Want to just dig into the data? Check out the links and scripts <a href="#below">below.</a></p>
									
											<p>I developed a fairly straightforward strategy for this study in a cab-ride to my finance’s place. Yes there was subway construction that day.</p>
												<ol><li>Collect a minute-by-minute level summary of taxi-trips. </li>
													<li>Map daily construction status to the taxi-trip table.</li>
													<li>Run several statistical diagnostics on varialbes using construction status as independent variables.</li>
													<li>Visualize those key statistics over time.</li>
													<li>Calculate the integrals of each curve and then find the differences.</li>
													<li>Ship the results on my own website!</li></ol>
											
											<p><b>EASIER SAID THAN DONE</b></p>
									
											<p>Before I get started, I’d be remiss to say that the work above was not possible six months ago. Taxi-trip records were released on an annual basis in separate tables and the MTA didn’t share public records of subway construction. Two fortunate things happened:</p> 
											<blockquote><ol><li><b>August:</b> The Taxi and Limousine Commission in coordination with NYC’s Open Data initiative worked with Google to host all taxi-trip records on BigQuery (Google’s service for big data analysis).</li>
											<li><b>Late October:</b>My FOIA request to the city for the dates and extent of construction on the 4,5,6 was fulfilled and they shared a treasure trove of historical records.</li></blockquote>
									
											<h3>1) Collect a minute-by-minute level summary of taxi-trips.</h3>
												<p>The TLC recently partnered with Google’s BigQuery to create a table of every taxi-trip taken in the past five years. It is a wonder and a long-time coming. Previous releases were limited to a year and one would have to combine and query all of them locally. Today’s solution allows me to query 211MB of data in under 30seconds with complex requests. It is AWESOME. The dataset contains everything from the pick-up and drop-off coordinates to tip-amounts and the type of payment system integrated into the cab.</p>
												<p>90% of the query was SQL basics: pull the sum and average of several variables and group for the minute-by-minute summary. </p>
												<p>The other 10% - geofencing the trips - was harder than I anticipated. Manhattan doesn’t sit on perfect North-South latitudes/longitudes. The island is actually on a slant, in respect to True North, so using a simple “point-in-the-box” equation doesn’t work for querying broad swaths of land in NYC. In short, you end up getting squares that don’t align to the sector in question.</p>
												<p>The path of the 4,5,6 is slanted too, just like the rest of Manhattan. That makes it difficult to triangulate pick-up coordinates and filter whether they sit along the various stations of the Lexington Line. So I had to crack open my old trigonometry textbook and find a generalized approach.</p>
												<p>I picked four points at the northern and southern end of Manhattan. The resulting rectangle provided a stretch of the city with a standard deviation of a block from the subway entrances in question. With those coordinates I created an equation that would take any given pick-up location and test whether the distance between that point and each four corners is greater than the sum of each side of the rectangle. Some online examples of this are <a href="http://www.emanueleferonato.com/2012/03/09/algorithm-to-determine-if-a-point-is-inside-a-square-with-mathematics-no-hit-test-involved/">here</a>, <a href="http://martin-thoma.com/how-to-check-if-a-point-is-inside-a-rectangle/">here</a>, and <a href="http://stackoverflow.com/questions/2752725/finding-whether-a-point-lies-inside-a-rectangle-or-not">here</a>.</p>
												<p>After testing this formula several times placed the code into the full query and pulled the trigger. <b>Step one done.</b></p>
										
										
											<h3>2) Map daily construction status to the taxi-trip table.</h3>
												<p>The MTA posts data every minute, but finding historical and aggregated information is difficult. You’d think this is a distribution-with-the-public-problem, but the MTA didn’t have a central store of historical construction data. “We found someone in finance who tracks this for his work, here’s his file.” They were gracious working with me to obtain the file, but it wasn’t plug-and-play.</p>
												<p>There’s a famous quote that 90% of “data science” is just getting your information into a format friendly for processing. That was certainly the case here. The FOIA file that the MTA shared with me was a trainwreck (pun-intended).</p>
												<p>Every month going back to 2010 had its own tab and days with construction were marked not by character or digit — but rather color-coded. So I had to hand-code a binary 1-or-0 for the appropriate status of subway construction for each day between 2012 and 2015. The Google-spreadsheet I’ve shared below contains that mapping and further explanation.</p>
										
											<h3>3) Run several statistical diagnostics on varialbes using construction status as independent variables.</h3>
												<p>Before digging into higher modeling and visualization I wanted to make sure that I had the statistical grounding to move forward and demonstrate differences.</p>
												<p>This is pretty boring. If you’ve read this far, just dive into the R script below where I’ve got several box-plots that find statistically significant differences between both # of rides and revenues between days with/without subway construction.</p>
										
											<h3>4) Visualize those key statistics over time.</h3>
												<p>The ggplot2 package for R is always great. I found a beautiful theme function that I’ve posted on my Github. It allows you to format your entire plot and avoid messy plotting scripts by calling the function instead of incorporating those arguments into the command.</p>
										
											<h3>5) Calculate the integrals of each curve and then find the differences.</h3>
												<p>This was fun! An R package called Bolstad2 contains the necessary integrating functions to calculate the same curve as the geom_smooth writes for the plot. By subtracting the specific integrals for each day’s summary curve we get the difference figure.</p>

											<h3>6) Ship the results on my own website!</h3>
												<p>I’ll spare you the details of my personal development in HTML and CSS prowess and jump right into the fun stuff: graphs and images!</p>
												<p>CartoDB was a pretty great place to throw data into their application and get sharp, reliable, scalable graphs on the other side. They have made significant improvement in their product over the past year. Importing data is a breeze and they have great options for embedding and deployment. They’ve even managed to perform some iframe witchcraft that prevents the user from accidentally zooming into the map as they scroll. Thumbs up team!</p>
												<p>On another note, I tried to use JuxtaposeJS for a “before-and-after” slider. Their embed option is really finicky and wrangling the object’s size is a pain in the @$$ so I gave up and replaced that idea with the gif. Same idea, but the slider would have been cool.</p>
												<p>Lastly, moving images from R plots into websites is a pain. An easy remedy is *not* to listen to bloggers talking about using hi-res PNGs and just opting to get the SVG file, throwing that straight into your directory and rendering on the browser. The image looks better and it’s automatically responsive.</p>
										
									
									
											<h3 id="below">Downloads+Links</h3>
											<p><a href="https://bigquery.cloud.google.com/table/nyc-tlc:yellow.trips">Google BigQuery Yellow-Cab Tables</a><p>
											<p><a href="https://michaelcata.com/data/fulltaxidata.csv">Minute-level summary of Yellow-Cab rides (CSV File Generated with the Query Above)</a><p>
											<p><a href="https://docs.google.com/spreadsheets/d/1swGHQMnAgseqQ3JKEGwxA1G0xIOGMHG3axhB_BQXdIU/edit#gid=0">Data Dictionary to ^</a><p>
											<p><a href="https://michaelcata.com/data/MTA_CONSTRUCTION_FOIA_RESPONSE.xls">MTA Construction Data via FOIA response</a><p>
											<p><a href="https://docs.google.com/spreadsheets/d/1KN7pKVpA5mgY7tIOsf7xMFDuU07GKdb2i9lPfUKf01g/edit#gid=0">Hand-coded MTA Construction Data for the 4,5,6</a><p>
									
											<h3>BigQuery Language</h3>
											<pre><code>SELECT  

		 avg(total_amount) as avgcost, 
		 sum(total_amount) as sumcost, 
		 avg(passenger_count) as avgpassengers, 
		 sum(passenger_count) as sumpassengers, 
		 count(vendor_id) as rides, 
		 left(time(pickup_datetime), 5) as timer,
		 hour(pickup_datetime) as hourr,
		 date(pickup_datetime) as dayy
 
		 FROM [nyc-tlc:yellow.trips] 

		 WHERE 

		 (SQRT(((-73.9493608 - pickup_longitude)*(-73.9493608 - pickup_longitude) + (40.7909394 - pickup_latitude)*(40.7909394 - pickup_latitude))) +
		 SQRT(((-73.9460564 - pickup_longitude)*(-73.9460564 - pickup_longitude) + (40.7896073 - pickup_latitude)*(40.7896073 - pickup_latitude))) +
		 SQRT(((-74.0172958 - pickup_longitude)*(-74.0172958 - pickup_longitude) + (40.6918326 - pickup_latitude)*(40.6918326 - pickup_latitude))) +
		 SQRT(((-74.0207291 - pickup_longitude)*(-74.0207291 - pickup_longitude) + (40.6936548 - pickup_latitude)*(40.6936548 - pickup_latitude)))) < 0.2419078579274
 
		 AND 
 
		 year(pickup_datetime)>2009
 
		 GROUP BY dayy, timer, hourr 
 
		 ORDER BY dayy, timer, hourr
 
		 LIMIT 50000000</code></pre>
									
											<h5>R Scripts</h5>
											<pre><code>library("curl")
		library("scales")
		library("sqldf")
		library("ggplot2")
		library("jsonlite")
		library("dplyr")
		library("plyr")
		library("scales")
		library("tidyr")
		library("dplyr")
		library("mgcv")
		library("magrittr")
		library("ROCR")
		library("grid")
		library("extrafont")
		library("Cairo")

		####################################################
		### Google BigQuery Results
		taxicosts <- read.csv("/Users/michaelcata/Documents/NYC_GIT/Taxi/fulltaxidata.csv", 
		                      header = TRUE, stringsAsFactors = FALSE)

		### Cleaning
		taxicosts$dayy <- as.Date(taxicosts$dayy)
		#taxicosts$timer <- strptime(taxicosts$timer, "%H:%M")
		##taxicosts$timer <- as.POSIXct(taxicosts$timer)
		taxicosts$dayofweek <- weekdays(taxicosts$dayy)
		taxicosts$dayofweek <- factor(taxicosts$dayofweek, 
		                              levels = c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"))

		### Construction Data
		csched <- read.csv("/Users/michaelcata/Documents/NYC_GIT/Taxi/subwayconstruction3.csv", header = TRUE, stringsAsFactors = FALSE)

		### Cleaning
		csched$cdate <- as.Date(csched$cdate)
		csched$LexAll <- factor(csched$LexAll)
		csched$LexRed <- factor(csched$LexRed)
		csched$AllRed <- factor(csched$AllRed)

		combined <- sqldf("select * from taxicosts join csched on dayy = cdate")
		combined$LexAll <- factor(combined$LexAll)
		combined$LexRed <- factor(combined$LexRed)
		combined$AllRed <- factor(combined$AllRed)
		combined$dayy <- as.Date(combined$dayy)
		combined$dayofweek <- weekdays(combined$dayy)
		combined$dayofweek <- factor(combined$dayofweek, 
		                             levels = c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"))
		combined$timerr <- as.factor(combined$timer)
		combined$timerrr <- as.numeric(combined$timerr)



		#### construction status specific tables
		combinedn <- sqldf("select * from combined where LexAll = 0")
		combinedc <- sqldf("select * from combined where LexAll = 1")


		#### running the integrals for each day
		intcm <- sqldf("select * from combinedc where dayofweek = 'Monday'")
		intnm <- sqldf("select * from combinedc where dayofweek = 'Monday'")
		intcsat <- sqldf("select * from combinedc where dayofweek = 'Saturday'")
		intnsat <- sqldf("select * from combinedn where dayofweek = 'Saturday'")
		intcsun <- sqldf("select * from combinedc where dayofweek = 'Sunday'")
		intnsun <- sqldf("select * from combinedn where dayofweek = 'Sunday'")

		mondaydiff <- sintegral(intcm$timerrr, intcm$sumcost)$int - sintegral(intnm$timerrr, intnm$sumcost)$int
		saturdaydiff <- sintegral(intcsat$timerrr, intcsat$sumcost)$int - sintegral(intnsat$timerrr, intnsat$sumcost)$int
		sundaydiff <- sintegral(intcsun$timerrr, intcsun$sumcost)$int - sintegral(intnsun$timerrr, intnsun$sumcost)$int

		#### Subset days
		subday <- sqldf("select * from combined where (cdatee = '2013-07-06' OR cdatee = '2013-07-13') AND hourr between 17 AND 21")
		subday <- sqldf("select * from combined where (cdatee = '2013-07-06' OR cdatee = '2013-07-13')")
		ggplot(data = subday, aes(timer, y=sumcost,group=dayy,color=factor(dayy)))+geom_smooth()

		### timeline 
		ggplot(data = subset(combined, dayofweek %in% c("Saturday","Sunday")), aes(timerr, y=sumcost,group=LexAll,color=factor(LexAll))) +
		  geom_smooth(fill = "red", alpha = .025) +
		  facet_grid(~dayofweek)+labs(x='Time of Day',y="Average Taxi Revenue Per Minute") + 
		  scale_color_manual("Subway Status",  values = c("green", "red"),labels=c("Construction", "Normal"), breaks = rev(levels(combined$LexAll))) +
		  scale_x_discrete(breaks = c("00:00", "02:00", "04:00", "06:00", "08:00", "10:00", "12:00", "14:00", "16:00", "18:00", "20:00", "22:00")) +
		  theme_bw() +
		  theme(text=element_text(family="Microsoft Sans Serif"), panel.grid.major.x = element_line(color = "gray"), panel.grid.major.y = element_line(color = "black"),  panel.margin = unit(1,"lines"), axis.title.y=element_text(vjust=1.5), axis.title.x=element_text(vjust=.1), plot.title = element_text(lineheight=.8, face="bold", hjust = .01, vjust = 1.5)) +
		  scale_y_continuous(labels = dollar)+ ggtitle("Minute-by-minute Taxi Revenue\n4,5,6 Corridor in Manhattan")


		## timeline for union square snapshot day
		ggplot(data = subday, aes(timerr, y=sumcost,group=dayy,color=factor(dayy)))+geom_smooth(fill = "red", alpha = .05)+labs(x='Time of Day',y="Average Taxi Revenue Per Minute") + scale_color_manual("Subway Status",  values = c("green", "red"),labels=c("Construction", "Normal"), breaks = rev(levels(subday$dayy))) + scale_x_discrete(breaks = c("00:00", "02:00", "04:00", "06:00", "08:00", "10:00", "12:00", "14:00", "16:00", "18:00", "20:00", "22:00"))


		### rides boxplots
		ggplot(data = subset(combined, dayofweek %in% c("Saturday","Sunday")), aes(factor(LexAll), y=rides,group=LexAll,color=factor(LexAll))) +
		   geom_boxplot(outlier.colour = "gray", alpha = .01) +
		   facet_grid(~dayofweek) +
		   stat_summary(fun.y=median, geom="line", aes(group=1)) +
		   scale_color_manual("Subway Status",  values = c("seagreen3", "indianred4"),labels=c("Construction", "Normal"), breaks = rev(levels(combined$LexAll))) +
		   theme_bw() +
		   theme(text=element_text(family="Microsoft Sans Serif"),  panel.margin = unit(1,"lines"), axis.title.y=element_text(vjust=1.5), axis.title.x=element_text(vjust=.1), plot.title = element_text(lineheight=.8, face="bold", hjust = .01, vjust = 1.5), axis.ticks.x = element_blank(), axis.text.x = element_blank(), legend.position = "bottom" ) +
		   labs(x='',y="") +
		   ylim(0, 120) +
		   scale_fill_discrete(guide = guide_legend(reverse=TRUE)) +
		   ggtitle("Average Pickups Per Minute")


		### sumcost boxplots
		ggplot(data = subset(combined, dayofweek %in% c("Saturday","Sunday")), aes(factor(LexAll), y=sumcost, group=LexAll, color=factor(LexAll))) +
		   geom_boxplot(outlier.colour = "gray", alpha = .01) +
		   facet_grid(~dayofweek) +
		   stat_summary(fun.y=median, geom="line", aes(group=1), "indianred3") +
		   scale_color_manual("Subway Status",  values = c("seagreen3", "indianred4"),labels=c("Construction", "Normal"), breaks = rev(levels(combined$LexAll))) +
		   theme_bw() +
		   theme(text=element_text(family="Microsoft Sans Serif"),  panel.margin = unit(1,"lines"), axis.title.y=element_text(vjust=1.5), axis.title.x=element_text(vjust=.1), plot.title = element_text(lineheight=.8, face="bold", hjust = .01, vjust = 1.5), axis.ticks.x = element_blank(), axis.text.x = element_blank(), legend.position = "bottom" ) +
		   labs(x='',y="") +
		   scale_fill_discrete(guide = guide_legend(reverse=TRUE)) +
		   ggtitle("Average Revenue Per Minute") +
		   ylim(0, 1750)


		### stat plots aka proof
		p <- ggplot(combined, aes(x=rides))
		pu <- ddply(combined, "LexAll", summarise, grp.mean=mean(rides))
		ridesdensityplot <- p + geom_density(aes(color = factor(LexAll))) + xlim(0,150) + geom_vline(data = pu, aes(xintercept=grp.mean, color = LexAll), linetype="dashed")

		m <- ggplot(combined, aes(x=sumcost))
		mu <- ddply(combined, "LexAll", summarise, grp.mean=mean(sumcost))
		costdensityplot <- m + geom_density(aes(color = factor(LexAll))) + xlim(0,1750) + geom_vline(data = mu, aes(xintercept=grp.mean, color = LexAll), linetype="dashed")

		# density plots
		costcdensityplot <- m + stat_ecdf(aes(color = factor(LexAll))) + xlim(0,1750) + geom_vline(data = mu, aes(xintercept=grp.mean, color = LexAll), linetype="dashed")
		ridescdensityplot <- p + stat_ecdf(aes(color = factor(LexAll))) + xlim(0,175) + geom_vline(data = pu, aes(xintercept=grp.mean, color = LexAll), linetype="dashed")

		##########################################################</code></pre>
									
									
											<hr />
									
											<header>
												<h2>Get in touch!</h2>
												<p>I tried to cram every morsel of insight into this piece of work, but there's a lot missing I'm sure. If you're interested in learning more about this project please don't hesitate to reach out.</p>
												<p>Reach me at michael@michaelcata.com</p>
											</header>
      </div>
      <div class="button-wrapper"><a href="all-posts.html" class="w-button button">←&nbsp;View all posts</a>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script type="text/javascript" src="js/webflow.js"></script>
  <!--[if lte IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif]-->
</body>
</html>